<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Master - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background: linear-gradient(to right, #34495e, #2ecc71);
            color: white;
            min-height: 100vh;
        }
        .admin-container {
            max-width: 2300px;
            margin: auto;
            margin-top: 50px;
            padding: 30px;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
        }
        .btn-custom {
            padding: 8px 15px;
            border-radius: 20px;
        }
        .card-item {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 15px;
            padding: 15px;
        }
        .card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .modal-content {
            background-color: #2c3e50;
            color: white;
        }
        .form-control {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .form-control:focus {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .nested-container {
            margin-left: 30px;
            border-left: 2px solid rgba(255, 255, 255, 0.2);
            padding-left: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-user-shield me-2"></i>Admin Dashboard</h2>
                <div>
                    <a href="/logout" class="btn btn-danger btn-custom"><i class="fas fa-sign-out-alt me-2"></i>Logout</a>
                </div>
            </div>
            <div class="search-container mb-4">
                <form action="/search" method="GET">
                    <div class="input-group">
                        <input type="text" class="form-control me-2" placeholder="Search for subjects, chapters, or quizzes" name="query" required>
                        <button class="btn btn-warning" type="submit">Search</button>
                    </div>
                </form>
            </div>
            <div class="card bg-dark text-white mb-4">
                <div class="card-body">
                    <h4 class="card-title"><i class="fas fa-book me-2"></i>Subject Management</h4>
                    <button class="btn btn-success mt-2" data-bs-toggle="modal" data-bs-target="#addSubjectModal"><i class="fas fa-plus me-2"></i>Add New Subject</button>
                </div>
            </div>
            <div id="subjects-container"></div>
        </div>
    </div>
    <div class="modal fade" id="addSubjectModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Add New Subject</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-subject-form">
                        <div class="mb-3">
                            <label for="subject-name" class="form-label">Subject Name</label>
                            <input type="text" class="form-control" id="subject-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="subject-description" class="form-label">Description</label>
                            <textarea class="form-control" id="subject-description" rows="3"></textarea>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-warning">Save Subject</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addChapterModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-book-open me-2"></i>Add New Chapter</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-chapter-form">
                        <input type="hidden" id="chapter-subject-id">
                        <div class="mb-3">
                            <label for="chapter-name" class="form-label">Chapter Name</label>
                            <input type="text" class="form-control" id="chapter-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="chapter-description" class="form-label">Description</label>
                            <textarea class="form-control" id="chapter-description" rows="3"></textarea>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-warning">Save Chapter</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addQuizModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-clipboard-list me-2"></i>Add New Quiz</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-quiz-form">
                        <input type="hidden" id="quiz-chapter-id">
                        <div class="mb-3">
                            <label for="quiz-date" class="form-label">Quiz Date</label>
                            <input type="date" class="form-control" id="quiz-date" required>
                        </div>
                        <div class="mb-3">
                            <label for="quiz-duration" class="form-label">Time Duration (minutes)</label>
                            <input type="number" class="form-control" id="quiz-duration" required>
                        </div>
                        <div class="mb-3">
                            <label for="quiz-remarks" class="form-label">Remarks</label>
                            <textarea class="form-control" id="quiz-remarks" rows="3"></textarea>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-warning">Save Quiz</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addQuestionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-question-circle me-2"></i>Add New Question</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-question-form">
                        <input type="hidden" id="question-quiz-id">
                        <div class="mb-3">
                            <label for="question-text" class="form-label">Question Text</label>
                            <textarea class="form-control" id="question-text" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Multiple Choice Options</label>
                            <div id="mcq-options-container">
                                <div class="mb-2">
                                    <div class="input-group">
                                        <div class="input-group-text">
                                            <input class="form-check-input mt-0" type="radio" name="correct-option" value="0" required>
                                        </div>
                                        <input type="text" class="form-control" placeholder="Option A" name="option1" required>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="input-group">
                                        <div class="input-group-text">
                                            <input class="form-check-input mt-0" type="radio" name="correct-option" value="1" required>
                                        </div>
                                        <input type="text" class="form-control" placeholder="Option B" name="option2" required>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="input-group">
                                        <div class="input-group-text">
                                            <input class="form-check-input mt-0" type="radio" name="correct-option" value="2" required>
                                        </div>
                                        <input type="text" class="form-control" placeholder="Option C" name="option3" required>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="input-group">
                                        <div class="input-group-text">
                                            <input class="form-check-input mt-0" type="radio" name="correct-option" value="3" required>
                                        </div>
                                        <input type="text" class="form-control" placeholder="Option D" name="option4" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-warning">Save Question</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div id="subjects-container"></div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadSubjects();
            document.getElementById('add-subject-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addSubject();});
            document.getElementById('add-chapter-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addChapter();});
            document.getElementById('add-quiz-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addQuiz();});
            document.getElementById('add-question-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addQuestion();});
        });

        function addSubject() {
            const name = document.getElementById('subject-name').value;
            const description = document.getElementById('subject-description').value;
            fetch('/admin/add_subject', {method: 'POST', headers: {'Content-Type': 'application/json',},body: JSON.stringify({ name, description })})
            .then(response => response.json())
            .then(data => {
                document.getElementById('subject-name').value = '';
                document.getElementById('subject-description').value = '';
                bootstrap.Modal.getInstance(document.getElementById('addSubjectModal')).hide();
                loadSubjects();})
            .catch(error => {
                console.error('Error adding subject:', error);
                alert('Error adding subject. Please try again.');});
        }
        function loadSubjects() {
            fetch('/admin/subjects')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('subjects-container');
                    container.innerHTML = '';
                    if (data.length === 0) {
                        container.innerHTML = '<div class="alert alert-info">No subjects found. Add your first subject!</div>';
                        return;
                    }
                    data.forEach(subject => {
                        const subjectCard = document.createElement('div');
                        subjectCard.className = 'card-item';
                        subjectCard.innerHTML = `
                            <div class="d-flex justify-content-between align-items-top">
                                <div>
                                    <h4>${subject.name}</h4>
                                    <p class="text-light">${subject.description || 'No description provided'}</p>
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-info" onclick="prepareAddChapter(${subject.id})">
                                        <i class="fas fa-plus"></i> Add Chapter
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="prepareEditSubject(${subject.id}, '${subject.name}', '${subject.description || ''}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="prepareDeleteSubject(${subject.id}, '${subject.name}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                            <div id="chapters-container-${subject.id}" class="nested-container mt-3"></div>
                        `;
                        container.appendChild(subjectCard);
                        loadChapters(subject.id);});})
                .catch(error => {
                    console.error('Error loading subjects:', error);
                    document.getElementById('subjects-container').innerHTML = '<div class="alert alert-danger">Error loading subjects. Please try again later.</div>';});
        }
        function prepareEditSubject(subjectId, name, description) {
            fetch(`/admin/edit_subject/${subjectId}`, {method: 'PUT', headers: {'Content-Type': 'application/json',}, body: JSON.stringify({ name, description })})
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                loadSubjects();})
            .catch(error => {
                console.error('Error editing subject:', error);
                alert('Error editing subject. Please try again.');});
        }
        function prepareDeleteSubject(subjectId) {
            if (confirm('Are you sure you want to delete this subject? This will also delete associated chapters and quizzes.')) {
                fetch(`/admin/delete_subject/${subjectId}`, {method: 'DELETE'})
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    loadSubjects();})
                .catch(error => {
                    console.error('Error deleting subject:', error);
                    alert('Error deleting subject. Please try again.');});
            }
        }
        function addChapter() {
            const subjectId = document.getElementById('chapter-subject-id').value;
            const name = document.getElementById('chapter-name').value;
            const description = document.getElementById('chapter-description').value;
            fetch('/admin/add_chapter', {method: 'POST', headers: {'Content-Type': 'application/json',}, body: JSON.stringify({ subject_id: subjectId, name, description })})
            .then(response => response.json())
            .then(data => {
                document.getElementById('chapter-name').value = '';
                document.getElementById('chapter-description').value = '';
                bootstrap.Modal.getInstance(document.getElementById('addChapterModal')).hide();
                loadSubjects();})
            .catch(error => {
                console.error('Error adding chapter:', error);
                alert('Error adding chapter. Please try again.');});
        }
        function loadChapters(subjectId) {
            fetch(`/admin/chapters/${subjectId}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById(`chapters-container-${subjectId}`);
                    container.innerHTML = '';
                    if (data.length === 0) {
                        container.innerHTML = '<div class="text-muted">No chapters found for this subject.</div>';
                        return;
                    }
                    data.forEach(chapter => {
                        const chapterCard = document.createElement('div');
                        chapterCard.className = 'card-item bg-dark mt-2';
                        chapterCard.innerHTML = `
                            <div class="d-flex justify-content-between align-items-top">
                                <div>
                                    <h5>${chapter.name}</h5>
                                    <p class="text-light">${chapter.description || 'No description provided'}</p>
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-info" onclick="prepareAddQuiz(${chapter.id})">
                                        <i class="fas fa-plus"></i> Add Quiz
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="prepareEditChapter(${chapter.id}, '${chapter.name}', '${chapter.description || ''}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="prepareDeleteChapter(${chapter.id}, '${chapter.name}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                            <div id="quizzes-container-${chapter.id}" class="nested-container mt-3"></div>
                        `;
                        container.appendChild(chapterCard);
                        loadQuizzes(chapter.id);});})
                .catch(error => {
                    console.error('Error loading chapters:', error);});
        }
        function prepareAddChapter(subjectId) {
            document.getElementById('chapter-subject-id').value = subjectId;
            new bootstrap.Modal(document.getElementById('addChapterModal')).show();
        }
        function prepareEditChapter(chapterId, name, description) {
            fetch(`/admin/edit_chapter/${chapterId}`, {method: 'PUT', headers: {'Content-Type': 'application/json',}, body: JSON.stringify({ name, description })})
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                loadSubjects();})
            .catch(error => {
                console.error('Error editing chapter:', error);
                alert('Error editing chapter. Please try again.');});
        }
        function prepareDeleteChapter(chapterId) {
            if (confirm('Are you sure you want to delete this chapter? This will also delete associated quizzes.')) {
                fetch(`/admin/delete_chapter/${chapterId}`, {method: 'DELETE'})
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    loadSubjects();})
                .catch(error => {
                    console.error('Error deleting chapter:', error);
                    alert('Error deleting chapter. Please try again.');});
            }
        }
        function addQuiz() {
            const chapterId = document.getElementById('quiz-chapter-id').value;
            const date = document.getElementById('quiz-date').value;
            const duration = document.getElementById('quiz-duration').value;
            const remarks = document.getElementById('quiz-remarks').value;
            fetch('/admin/add_quiz', {method: 'POST', headers: {'Content-Type': 'application/json',}, body: JSON.stringify({ chapter_id: chapterId, date_of_quiz: date, time_duration: duration, remarks })})
            .then(response => response.json())
            .then(data => {
                document.getElementById('quiz-date').value = '';
                document.getElementById('quiz-duration').value = '';
                document.getElementById('quiz-remarks').value = '';
                bootstrap.Modal.getInstance(document.getElementById('addQuizModal')).hide();
                loadSubjects();})
            .catch(error => {
                console.error('Error adding quiz:', error);
                alert('Error adding quiz. Please try again.');});
        }
        function loadQuizzes(chapterId) {
            fetch(`/admin/quizzes/${chapterId}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById(`quizzes-container-${chapterId}`);
                    container.innerHTML = '';
                    if (data.length === 0) {
                        container.innerHTML = '<div class="text-muted">No quizzes found for this chapter.</div>';
                        return;
                    }
                    data.forEach(quiz => {
                        const quizCard = document.createElement('div');
                        quizCard.className = 'card-item bg-secondary mt-2';
                        quizCard.innerHTML = `
                            <div class="d-flex justify-content-between align-items-top">
                                <div>
                                    <h6>Quiz on ${new Date(quiz.date_of_quiz).toLocaleDateString()}</h6>
                                    <p class="text-light">Duration: ${quiz.time_duration} minutes</p>
                                    <p class="text-light">${quiz.remarks || 'No additional remarks'}</p>
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-info" onclick="prepareAddQuestion(${quiz.id})">
                                        <i class="fas fa-plus"></i> Add Question
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="prepareEditQuiz(${quiz.id}, '${quiz.date_of_quiz}', '${quiz.time_duration}', '${quiz.remarks || ''}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="prepareDeleteQuiz(${quiz.id})">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                            <div id="questions-container-${quiz.id}" class="nested-container mt-3"></div>
                        `;
                        container.appendChild(quizCard);
                        loadQuestions(quiz.id);});})
                .catch(error => {
                    console.error('Error loading quizzes:', error);});
        }
        function prepareAddQuiz(chapterId) {
            document.getElementById('quiz-chapter-id').value = chapterId;
            new bootstrap.Modal(document.getElementById('addQuizModal')).show();
        }
        function prepareEditQuiz(quizId, dateOfQuiz, timeDuration, remarks) {
            fetch(`/admin/edit_quiz/${quizId}`, {method: 'PUT', headers: {'Content-Type': 'application/json',},body: JSON.stringify({ date_of_quiz: dateOfQuiz, time_duration: timeDuration, remarks })})
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                loadSubjects();})
            .catch(error => {
                console.error('Error editing quiz:', error);
                alert('Error editing quiz. Please try again.');});
        }
        function prepareDeleteQuiz(quizId) {
            if (confirm('Are you sure you want to delete this quiz?')) {
                fetch(`/admin/delete_quiz/${quizId}`, {method: 'DELETE'})
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    loadSubjects();})
                .catch(error => {
                    console.error('Error deleting quiz:', error);
                    alert('Error deleting quiz. Please try again.');});
            }
        }
        function addQuestion() {
            const quizId = document.getElementById('question-quiz-id').value;
            const questionText = document.getElementById('question-text').value;
            const options = document.querySelectorAll('#mcq-options-container input[type="text"]');
            const correctOptionRadios = document.querySelectorAll('input[name="correct-option"]');
            const correctOptionIndex = Array.from(correctOptionRadios).findIndex(radio => radio.checked);
            if (correctOptionIndex === -1) {
                alert('Please select a correct option');
                return;
            }
            fetch('/admin/add_question', {method: 'POST', headers: {'Content-Type': 'application/json',},body: JSON.stringify({quiz_id: quizId, question_statement: questionText, option1: options[0].value, option2: options[1].value, option3: options[2].value, option4: options[3].value, correct_option: correctOptionIndex})})
            .then(response => response.json())
            .then(data => {
                document.getElementById('question-text').value = '';
                options.forEach(option => option.value = '');
                correctOptionRadios.forEach(radio => radio.checked = false);
                
                bootstrap.Modal.getInstance(document.getElementById('addQuestionModal')).hide();
                loadSubjects();})
            .catch(error => {
                console.error('Error adding question:', error);
                alert('Error adding question. Please try again.');});
        }
        function loadQuestions(quizId) {
            fetch(`/admin/questions/${quizId}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById(`questions-container-${quizId}`);
                    container.innerHTML = '';
                    if (data.length === 0) {
                        container.innerHTML = '<div class="text-muted">No questions found for this quiz.</div>';
                        return;
                    }
                    data.forEach(question => {
                        const questionCard = document.createElement('div');
                        questionCard.className = 'card-item bg-info mt-2';
                        questionCard.innerHTML = `
                            <div class="d-flex justify-content-between align-items-top">
                                <div>
                                    <h6>${question.question_statement}</h6>
                                    <p>A: ${question.option1}</p>
                                    <p>B: ${question.option2}</p>
                                    <p>C: ${question.option3}</p>
                                    <p>D: ${question.option4}</p>
                                    <p class="text-success">Correct Option: ${['A', 'B', 'C', 'D'][question.correct_option]}</p>
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-warning" onclick="prepareEditQuestion(${question.id}, '${question.question_statement}', '${question.option1}', '${question.option2}', '${question.option3}', '${question.option4}', ${question.correct_option})">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="prepareDeleteQuestion(${question.id})">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        `;
                        container.appendChild(questionCard);});})
                .catch(error => {
                    console.error('Error loading questions:', error);});
        }
        function prepareAddQuestion(quizId) {
            document.getElementById('question-quiz-id').value = quizId;
            new bootstrap.Modal(document.getElementById('addQuestionModal')).show();
        }
        function prepareEditQuestion(questionId, questionText, option1, option2, option3, option4, correctOption) {
            fetch(`/admin/edit_question/${questionId}`, {method: 'PUT', headers: {'Content-Type': 'application/json',}, body: JSON.stringify({question_statement: questionText,option1: option1,option2: option2, option3: option3,option4: option4,correct_option: correctOption})})
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                loadSubjects();})
            .catch(error => {
                console.error('Error editing question:', error);
                alert('Error editing question. Please try again.');});
        }
        function prepareDeleteQuestion(questionId) {
            if (confirm('Are you sure you want to delete this question?')) {
                fetch(`/admin/delete_question/${questionId}`, {method: 'DELETE'})
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    loadSubjects();})
                .catch(error => {
                    console.error('Error deleting question:', error);
                    alert('Error deleting question. Please try again.');});
            }
        }
    </script>
</body>
</html>
